<table mat-table [dataSource]="dataSource" matSort>
  @for (col of internalColumns; track col?.def ?? $index; let index = $index) {
    @if (col) {
    <ng-container [matColumnDef]="col.def" [sticky]="false">
      @if (col.sortable) {
        <th mat-header-cell *matHeaderCellDef [mat-sort-header]="col.def"
          [matTooltip]="col.tooltip" matTooltipClass="tooltip" [cdkContextMenuTriggerFor]="headermenu"
          (cdkContextMenuOpened)="selectedColumn = col">
          @if (col.headerImage) {
            @switch (col.headerImageType) {
              @case (0) {
                <img [src]="col.headerImage" alt="" style="max-height:1.4em;vertical-align:middle;" />
              }
              @case (1) {
                <mat-icon>{{ col.headerImage }}</mat-icon>
              }
              @case (2) {
                <mat-icon fontSet="material-symbols-outlined">{{ col.headerImage }}</mat-icon>
              }
              @default {
                <img [src]="col.headerImage" alt="" style="max-height:1.4em;vertical-align:middle;" />
              }
            }
          } @else {
            {{col.header}}
          }
        </th>
      } @else {
        <th mat-header-cell *matHeaderCellDef
          [matTooltip]="col.tooltip" matTooltipClass="tooltip" [cdkContextMenuTriggerFor]="headermenu"
          (cdkContextMenuOpened)="selectedColumn = col">
          @if (col.headerImage) {
            @switch (col.headerImageType) {
              @case (0) {
                <img [src]="col.headerImage" alt="" style="max-height:1.4em;vertical-align:middle;" />
              }
              @case (1) {
                <mat-icon>{{ col.headerImage }}</mat-icon>
              }
              @case (2) {
                <mat-icon fontSet="material-symbols-outlined">{{ col.headerImage }}</mat-icon>
              }
              @default {
                <img [src]="col.headerImage" alt="" style="max-height:1.4em;vertical-align:middle;" />
              }
            }
          } @else {
            {{col.header}}
          }
        </th>
      }
      <td mat-cell *matCellDef="let element; let i = index"
        [ngClass]="{'negative-cell': safeGetCellValue(col, element, i) < 0}">
        @if (col.isImage) {
          <img [src]="safeGetVisibleCellValue(col, element, i)" alt=""
            [matTooltip]="safeGetCellTooltip(col, element, i)"
            [matTooltipDisabled]="!showTooltips || !safeGetCellTooltip(col, element, i)" />
          } @else {
            <span [matTooltip]="safeGetCellTooltip(col, element, i)"
              [matTooltipDisabled]="!showTooltips || !safeGetCellTooltip(col, element, i)"
              matTooltipClass="tooltip-secret">
              {{ safeGetVisibleCellValue(col, element, i) }}
              @if (col.subscript && safeGetSubscript(col, element)) {
                <sub>
                  {{ safeGetSubscript(col, element) }}
                </sub>
              }
            </span>
          }
        </td>
      </ng-container>
    }
    }

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
  </table>

  <ng-template #headermenu>
    <div class="col-context-menu" cdkMenu @menuFadeScale>
      <button class="col-context-menu-item" cdkMenuItem (click)="openPlot()"
        matTooltip="Plot column data" matTooltipPosition="right">
        <mat-icon>bar_chart</mat-icon>
      </button>
      <button class="col-context-menu-item" cdkMenuItem (click)="downloadCSV()"
        matTooltip="Download column as CSV" matTooltipPosition="right">
        <mat-icon>download</mat-icon>
      </button>
    </div>
  </ng-template>